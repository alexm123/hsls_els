---
title: "hsls_els"
format: pdf
editor: visual
---

1 = strongly disagree 2 = disagree 3 = agree 4 = strongly agree

i1 = Teen (9th / 11th grader) confident can do excellent job on (fall 2009 / spring 2012) math tests

i2 = Teen (9th / 11th grader) certain can understand (fall 2009 / spring 2012) math textbook

i3 = Can understand difficult math class (ELS ONLY!)

i4 = Teen confident can do an excellent job on math assignments

i5 = Teen certain can master skills in math course

Can understand difficult math class

## Turning warnings off (bad idea)
```{r}
options(warn = -1)
```

```{r}
library(dplyr)
library(lavaan)
library(ltm)
library(sjlabelled)
library(kableExtra)
library(sirt)
library(mirt)  

#source("code/download_data.R")
source("F:/Users/alex/OneDrive/Documents/data/prepare_data.R")

m_items <- paste0("i", 1:5)
m_items_2 <- paste0(m_items, "_2")
# get subset of relevant variables
dat <- dat[, c("stu_id", "sample", "sex", "dropout", m_items, m_items_2)]

dat$mean_score <- c(rowMeans(dat[dat$sample == "ELS", m_items], na.rm = TRUE),
                    rowMeans(dat[dat$sample == "HSLS", m_items[-3]], na.rm = TRUE))
dat$mean_score_2 <- c(rowMeans(dat[dat$sample == "ELS", m_items_2], na.rm = TRUE),
                    rowMeans(dat[dat$sample == "HSLS", m_items_2[-3]], na.rm = TRUE))

```

```{r}

# Creating only HSLS
hsls <- subset(dat, sample == "HSLS")

hsls_1 <- hsls[, c("i1", "i2", "i4", "i5")]
head(hsls_1)

hsls_2 <- hsls[, c("i1_2", "i2_2", "i4_2", "i5_2")]
head(hsls_2)

hsls_1_noNA <- na.omit(hsls_1)
hsls_2_noNA <- na.omit(hsls_2)


# Creating only ELS
els <- subset(dat, sample == "ELS")

els_1 <- els[, c("i1", "i2", "i3", "i4", "i5")]
head(els_1)

els_2 <- els[, c("i1_2", "i2_2", "i3_2", "i4_2", "i5_2")]
head(els_2)

els_1_noNA <- na.omit(els_1)
els_2_noNA <- na.omit(els_2)
```

```{r}

cfa_config <-  '
  group: ELS
  math =~ NA   * i1 + 
          el2_1 * i2 + 
          el3_1 * i3 + 
          el4_1 * i4 + 
          el5_1 * i5
          
  # Naming the intercepts!       
  i1 ~ nu1_1 * 1
  i2 ~ nu2_1 * 1
  i3 ~ nu3_1 * 1
  i4 ~ nu4_1 * 1
  i5 ~ nu5_1 * 1
  
  # Naming the residual variances!
  i1 ~~ theta1_1 * i1
  i2 ~~ theta2_1 * i2
  i3 ~~ theta3_1 * i3
  i4 ~~ theta4_1 * i4
  i5 ~~ theta5_1 * i5
  
  # Adding the covariances
  i1 ~~ i2
  i2 ~~ i3
  
  # Fixing latent variance to 1, as we freed first factor loading
  math ~~ 1 * math
  
  # Fixing latent mean to 0 for identification?
  math ~ 0 * 1      
     
     
  group: HSLS
  math =~ NA   * i1 + 
          hl2_2 * i2 + 
          hl4_2 * i4 + 
          hl5_2 * i5
          
  # Naming the intercepts! 
  i1 ~ nu1_2 * 1
  i2 ~ nu2_2 * 1
  i4 ~ nu4_2 * 1
  i5 ~ nu5_2 * 1
  
  # Naming the residual variances!
  i1 ~~ theta1_2 * i1
  i2 ~~ theta2_2 * i2
  i4 ~~ theta4_2 * i4
  i5 ~~ theta5_2 * i5
  
  # Adding the covariances
    #i1 ~~ i2
    i2 ~~ i4
  
  # Fixing latent variance to 1, as we freed first factor loading
  math ~~ 1 * math
  
  # Fixing latent mean to 0 for identification?
  math ~ 0 * 1  
'

fit_config  <- cfa(cfa_config, data = dat, group = "sample", 
                   estimator = "MLR", missing = "FIML", se = "robust.mlr")


s_config <- summary(fit_config, fit.measures = TRUE, standardized = TRUE)


mod_indices <- modindices(fit_config, sort. = TRUE, free.remove = FALSE)
head(mod_indices)

# Just for ELS
mod_indices_els <- mod_indices[mod_indices$group == "ELS", ]
head(mod_indices_els)


# Just for HSLS 
mod_indices_hsls <- mod_indices[mod_indices$group == "HSLS", ]
head(mod_indices_hsls)

```

#CONFIG ELS + HSLS 

```{r}
config_comb <-  '
  # ELS
  group: 1
  
  # Time point 1
  math_t1 =~ NA   * i1 + 
          el2_1 * i2 + 
          el3_1 * i3 + 
          el4_1 * i4 + 
          el5_1 * i5
          
  # Naming the intercepts!       
  i1 ~ enu1_1 * 1
  i2 ~ enu2_1 * 1
  i3 ~ enu3_1 * 1
  i4 ~ enu4_1 * 1
  i5 ~ enu5_1 * 1
  
  # Naming the residual variances!
  i1 ~~ etheta1_1 * i1
  i2 ~~ etheta2_1 * i2
  i3 ~~ etheta3_1 * i3
  i4 ~~ etheta4_1 * i4
  i5 ~~ etheta5_1 * i5
  
  # Fixing latent variance to 1, as we freed first factor loading
  math_t1 ~~ 1 * math_t1
  
  # Fixing latent mean to 0 for identification?
  math_t1 ~ 0 * 1      
     
  # Time point 2
   math_t2 =~ NA   * i1_2 + 
            el2_2 * i2_2 + 
            el3_2 * i3_2 + 
            el4_2 * i4_2 + 
            el5_2 * i5_2
          
  # Naming the intercepts!       
  i1_2 ~ enu1_2 * 1
  i2_2 ~ enu2_2 * 1
  i3_2 ~ enu3_2 * 1
  i4_2 ~ enu4_2 * 1
  i5_2 ~ enu5_2 * 1
  
  # Naming the residual variances!
  i1_2 ~~ etheta1_2 * i1_2
  i2_2 ~~ etheta2_2 * i2_2
  i3_2 ~~ etheta3_2 * i3_2
  i4_2 ~~ etheta4_2 * i4_2
  i5_2 ~~ etheta5_2 * i5_2
  
  
  ## Adding the covariances ##
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i3
  i1_2 ~~ i3_2

  i2 ~~ i3
  i2_2 ~~ i3_2

  i4 ~~ i5
  i4_2 ~~ i5_2

  
  # Fixing latent variance to 1, as we freed first factor loading
  math_t2 ~~ 1 * math_t2
  
  # Fixing latent mean to 0 for identification
  math_t2 ~ 0 * 1 
  
  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2     
     
 # HSLS
 group: 2
  # Time Point 1
  math_t1 =~ NA   * i1 + 
            hl2_1 * i2 + 
            #hl3_1 * i3 +
            hl4_1 * i4 + 
            hl5_1 * i5
          
  # Naming the intercepts! 
  i1 ~ hnu1_1 * 1
  i2 ~ hnu2_1 * 1
  #i3 ~ hnu3_1 * 1
  i4 ~ hnu4_1 * 1
  i5 ~ hnu5_1 * 1
  
  # Naming the residual variances!
  i1 ~~ htheta1_1 * i1
  i2 ~~ htheta2_1 * i2
  #i3 ~~ htheta3_1 * i3
  i4 ~~ htheta4_1 * i4
  i5 ~~ htheta5_1 * i5

  
  # Fixing latent variance to 1, as we freed first factor loading
  math_t1 ~~ 1 * math_t1
  
  # Fixing latent mean to 0 for identification
  math_t1 ~ 0 * 1  
  
  # Time Point 2
  math_t2 =~ NA   * i1_2 + 
             hl2_2 * i2_2 + 
             #hl3_2 * i3_2 +
             hl4_2 * i4_2 + 
             hl5_2 * i5_2
          
  # Naming the intercepts!       
  i1_2 ~ hnu1_2 * 1
  i2_2 ~ hnu2_2 * 1
  #i3_2 ~ hnu3_2 * 1
  i4_2 ~ hnu4_2 * 1
  i5_2 ~ hnu5_2 * 1
  
  # Naming the residual variances!
  i1_2 ~~ htheta1_2 * i1_2
  i2_2 ~~ htheta2_2 * i2_2
  #i3_2 ~~ htheta3_1 * i3_2
  i4_2 ~~ htheta4_2 * i4_2
  i5_2 ~~ htheta5_2 * i5_2
  
  ## Adding the covariances ##
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i2 ~~ i4
  i2_2 ~~ i4_2

  i1 ~~ i5
  i1_2 ~~ i5_2
  
  # Fixing latent variance to 1, as we freed first factor loading
  math_t2 ~~ 1 * math_t2
  
  # Fixing latent mean to 0 for identification
  math_t2 ~ 0 * 1
  
  
  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  #i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2     

'


fit_config_comb  <- cfa(config_comb, data = dat, group = "sample", 
                    estimator = "MLR", missing = "FIML", se = "robust.mlr")
fit_config_comb

head(modindices(fit_config_comb, sort. = TRUE, free.remove = FALSE))

fitmeasures(fit_config_comb, c("aic", "bic", "cfi", "df"))

s_config_comb <- summary(fit_config_comb, fit.measures = TRUE)
parTable(fit_config_comb)

```



# BETWEEN WEAK ELS + HSLS 

```{r}
weak_comb <- '

############################################################################
##                           ELS (Group 1)                                ##
############################################################################
group: ELS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1_1 * i1 +
             l2_1 * i2 +
             l3_1 * i3 +
             l4_1 * i4 +
             l5_1 * i5
            
  # Intercepts
  i1 ~ 0 * 1
  i2 ~ enu2_1 * 1
  i3 ~ enu3_1 * 1
  i4 ~ enu4_1 * 1
  i5 ~ enu5_1 * 1

  # Residual variances
  i1 ~~ etheta1_1 * i1
  i2 ~~ etheta2_1 * i2
  i3 ~~ etheta3_1 * i3
  i4 ~~ etheta4_1 * i4
  i5 ~~ etheta5_1 * i5

  # Free both
  math_t1 ~~ var_els_t1 * math_t1
  math_t1 ~ mean_els_t1 * 1 


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1_2   * i1_2 +
             l2_2 * i2_2 +
             l3_2 * i3_2 +
             l4_2 * i4_2 +
             l5_2 * i5_2

  # Intercepts
  i1_2 ~ 0 * 1
  i2_2 ~ enu2_2 * 1
  i3_2 ~ enu3_2 * 1
  i4_2 ~ enu4_2 * 1
  i5_2 ~ enu5_2 * 1

  # Residual variances
  i1_2 ~~ etheta1_2 * i1_2
  i2_2 ~~ etheta2_2 * i2_2
  i3_2 ~~ etheta3_2 * i3_2
  i4_2 ~~ etheta4_2 * i4_2
  i5_2 ~~ etheta5_2 * i5_2

  # Covariances among items
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i3
  i1_2 ~~ i3_2

  i2 ~~ i3
  i2_2 ~~ i3_2

  i4 ~~ i5
  i4_2 ~~ i5_2

  # Fix latent variance to 1 for identification, free mean
  math_t2 ~~ var_els_t2 * math_t2
  math_t2 ~ mean_els_t2 * 1
  
  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2


############################################################################
##                          HSLS (Group 2)                                ##
############################################################################
group: HSLS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1_1 * i1 +
             l2_1 * i2 +   # Same label as ELS
             # no i3 in HSLS
             l4_1 * i4 +   # Same label as ELS
             l5_1 * i5     # Same label as ELS

  # Intercepts
  i1 ~ 0 * 1
  i2 ~ hnu2_1 * 1
  # i3 ~ hnu3_1 * 1 (item not in HSLS)
  i4 ~ hnu4_1 * 1
  i5 ~ hnu5_1 * 1

  # Residual variances
  i1 ~~ htheta1_1 * i1
  i2 ~~ htheta2_1 * i2
  # i3 ~~ htheta3_1 * i3 (item not in HSLS)
  i4 ~~ htheta4_1 * i4
  i5 ~~ htheta5_1 * i5

  # Free latent variance and free latent mean
  math_t1 ~~ var_hsls_t1 * math_t1
  math_t1 ~ mean_hsls_t1 * 1 
  

  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1_2  * i1_2 +
             l2_2 * i2_2 +   # Same label as ELS
             # no i3_2 in HSLS at Time 2
             l4_2 * i4_2 +   # Same label as ELS
             l5_2 * i5_2     # Same label as ELS
             
             

  # Intercepts
  i1_2 ~ 0 * 1
  i2_2 ~ hnu2_2 * 1
  # i3_2 ~ hnu3_2 * 1 (item not in HSLS)
  i4_2 ~ hnu4_2 * 1
  i5_2 ~ hnu5_2 * 1

  # Residual variances
  i1_2 ~~ htheta1_2 * i1_2
  i2_2 ~~ htheta2_2 * i2_2
  # i3_2 ~~ htheta3_2 * i3_2 (item not in HSLS)
  i4_2 ~~ htheta4_2 * i4_2
  i5_2 ~~ htheta5_2 * i5_2

  # Covariances among items
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i2 ~~ i4
  i2_2 ~~ i4_2

  i1 ~~ i5
  i1_2 ~~ i5_2

  # Free latent variance and free latent mean
  math_t2 ~~ var_hsls_t2 * math_t2
  math_t2 ~ mean_hsls_math_t2 * 1  # free mean

  
  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  # i3 ~~ i3_2 (item not in HSLS)
  i4 ~~ i4_2
  i5 ~~ i5_2

'


fit_weak_comb  <- sem(weak_comb, data = dat, group = "sample", 
                    estimator = "MLR", missing = "FIML", se = "robust.mlr")
fit_weak_comb

head(modindices(fit_weak_comb, sort. = TRUE, free.remove = FALSE))

s_weak_comb <- summary(fit_weak_comb, fit.measures = TRUE, standardized = TRUE)
fitMeasures(fit_weak_comb, c("rmsea", "chisq.scaled", "cfi", "tli", "df"))
#s_weak_comb
#lavTestLRT(fit_config_comb, fit_weak_comb)
```

# BETWEEN STRONG ELS + HSLS

```{r}
strong_between <- '

############################################################################
##                           ELS (Group 1)                                ##
############################################################################
group: ELS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1_1    * i1 +
             l2_1 * i2 +
             l3_1 * i3 +
             l4_1 * i4 +
             l5_1 * i5

  # Intercepts
  # Same labels for both groups!
  i1 ~ 0 * 1
  i2 ~ nu2_1 * 1
  i3 ~ nu3_1 * 1
  i4 ~ nu4_1 * 1
  i5 ~ nu5_1 * 1

  # Residual variances
  i1 ~~ etheta1_1 * i1
  i2 ~~ etheta2_1 * i2
  i3 ~~ etheta3_1 * i3
  i4 ~~ etheta4_1 * i4
  i5 ~~ etheta5_1 * i5

  # Free both
  math_t1 ~~ var_els_t1 * math_t1
  math_t1 ~ mean_els_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1_2   * i1_2 +
             l2_2 * i2_2 +
             l3_2 * i3_2 +
             l4_2 * i4_2 +
             l5_2 * i5_2

  # Intercepts
  # Same labels for both groups!
  i1_2 ~ 0 * 1
  i2_2 ~ nu2_2 * 1
  i3_2 ~ nu3_2 * 1
  i4_2 ~ nu4_2 * 1
  i5_2 ~ nu5_2 * 1

  # Residual variances
  i1_2 ~~ etheta1_2 * i1_2
  i2_2 ~~ etheta2_2 * i2_2
  i3_2 ~~ etheta3_2 * i3_2
  i4_2 ~~ etheta4_2 * i4_2
  i5_2 ~~ etheta5_2 * i5_2

  # Covariances among items
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i3
  i1_2 ~~ i3_2

  i2 ~~ i3
  i2_2 ~~ i3_2

  i4 ~~ i5
  i4_2 ~~ i5_2

  # Fix latent variance to 1 for identification, free mean
  math_t2 ~~ var_els_t2 * math_t2
  math_t2 ~ mean_els_t2 * 1

  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2


############################################################################
##                          HSLS (Group 2)                                ##
############################################################################
group: HSLS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1_1   * i1 +
             l2_1 * i2 +   # Same label as ELS
             # no i3 in HSLS
             l4_1 * i4 +   # Same label as ELS
             l5_1 * i5     # Same label as ELS

  # Intercepts
  # Same labels for both groups!
  i1 ~ 0 * 1
  i2 ~ nu2_1 * 1
  # i3 ~ hnu3_1 * 1 (item not in HSLS)
  i4 ~ nu4_1 * 1
  i5 ~ nu5_1 * 1

  # Residual variances
  i1 ~~ htheta1_1 * i1
  i2 ~~ htheta2_1 * i2
  # i3 ~~ htheta3_1 * i3 (item not in HSLS)
  i4 ~~ htheta4_1 * i4
  i5 ~~ htheta5_1 * i5

 # Free both
  math_t1 ~~ var_hsls_t1 * math_t1
  math_t1 ~ mean_hsls_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1_2   * i1_2 +
             l2_2 * i2_2 +   # Same label as ELS
             # no i3_2 in HSLS at Time 2
             l4_2 * i4_2 +   # Same label as ELS
             l5_2 * i5_2     # Same label as ELS

  # Intercepts
  # Same labels for both groups!
  
  i1_2 ~ 0 * 1
  i2_2 ~ nu2_2 * 1
  # i3_2 ~ hnu3_2 * 1 (item not in HSLS)
  i4_2 ~ nu4_2 * 1
  i5_2 ~ nu5_2 * 1

  # Residual variances
  i1_2 ~~ htheta1_2 * i1_2
  i2_2 ~~ htheta2_2 * i2_2
  # i3_2 ~~ htheta3_2 * i3_2 (item not in HSLS)
  i4_2 ~~ htheta4_2 * i4_2
  i5_2 ~~ htheta5_2 * i5_2

  # Covariances among items
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i2 ~~ i4
  i2_2 ~~ i4_2

  i1 ~~ i5
  i1_2 ~~ i5_2
  
  # Free latent variance and free latent mean
  math_t2 ~~ var_hsls_t2 * math_t2
  math_t2 ~ mean_hsls_t2 * 1

  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  # i3 ~~ i3_2 (item not in HSLS)
  i4 ~~ i4_2
  i5 ~~ i5_2

'

fit_strong_between  <- sem(strong_between, data = dat, group = "sample", 
                    estimator = "MLR", missing = "FIML", se = "robust.mlr")
fit_strong_between

head(modindices(fit_strong_between, sort. = TRUE, free.remove = FALSE))

s_strong_between <- summary(fit_strong_between, fit.measures = TRUE, standardized = TRUE)
#s_strong_between
fitMeasures(fit_strong_between, c("rmsea", "chisq.scaled", "cfi", "tli", "df"))

fit_weak_comb
#lavTestLRT(fit_weak_comb, fit_strong_between)
```


# WITHIN STRONG ELS+HSLS
```{r}

strong_within <- '

############################################################################
##                           ELS (Group 1)                                ##
############################################################################
group: ELS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ el1    * i1 +
             el2 * i2 +
             el3 * i3 +
             el4 * i4 +
             el5 * i5

  # Intercepts
  # Same labels for both times!
  i1 ~ 0 * 1
  i2 ~ nu2_2 * 1
  i3 ~ nu3_3 * 1
  i4 ~ nu4_4 * 1
  i5 ~ nu5_5 * 1

  # Residual variances
  i1 ~~ etheta1_1 * i1
  i2 ~~ etheta2_1 * i2
  i3 ~~ etheta3_1 * i3
  i4 ~~ etheta4_1 * i4
  i5 ~~ etheta5_1 * i5

  # Fix latent variance to 1 for identification, fix mean to 0
  math_t1 ~~ 1 * math_t1
  math_t1 ~ mean_els_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ el1 * i1_2 +
             el2 * i2_2 +
             el3 * i3_2 +
             el4 * i4_2 +
             el5 * i5_2

  # Intercepts
  # Same labels for both groups!
  i1_2 ~ 0 * 1
  i2_2 ~ nu2_2 * 1
  i3_2 ~ nu3_2 * 1
  i4_2 ~ nu4_2 * 1
  i5_2 ~ nu5_2 * 1

  # Residual variances
  i1_2 ~~ etheta1_2 * i1_2
  i2_2 ~~ etheta2_2 * i2_2
  i3_2 ~~ etheta3_2 * i3_2
  i4_2 ~~ etheta4_2 * i4_2
  i5_2 ~~ etheta5_2 * i5_2

  # Covariances among items
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i3
  i1_2 ~~ i3_2

  i2 ~~ i3
  i2_2 ~~ i3_2

  i4 ~~ i5
  i4_2 ~~ i5_2

  # Fix latent variance to 1 for identification, free mean
  math_t2 ~~ var_els_t2 * math_t2
  math_t2 ~ mean_els_t2 * 1

  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2


############################################################################
##                          HSLS (Group 2)                                ##
############################################################################
group: HSLS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ hl1   * i1 +
             hl2 * i2 +   # Same label as ELS
             # no i3 in HSLS
             hl4 * i4 +   # Same label as ELS
             hl5 * i5     # Same label as ELS

  # Intercepts
  # Same labels for both times!
  i1 ~ 0 * 1
  i2 ~ hnu2_1 * 1
  # i3 ~ hnu3_1 * 1 (item not in HSLS)
  i4 ~ hnu4_1 * 1
  i5 ~ hnu5_1 * 1

  # Residual variances
  i1 ~~ htheta1_1 * i1
  i2 ~~ htheta2_1 * i2
  # i3 ~~ htheta3_1 * i3 (item not in HSLS)
  i4 ~~ htheta4_1 * i4
  i5 ~~ htheta5_1 * i5

 # Free latent variance and free latent mean
  math_t1 ~~ var_hsls * math_t1
  math_t1 ~ mean_hsls_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ hl1   * i1_2 +
             hl2 * i2_2 +   # Same label as ELS
             # no i3_2 in HSLS at Time 2
             hl4 * i4_2 +   # Same label as ELS
             hl5 * i5_2     # Same label as ELS

  # Intercepts
  # Same labels for both times!
  
  i1_2 ~ 0 * 1
  i2_2 ~ hnu2_2 * 1
  # i3_2 ~ hnu3_2 * 1 (item not in HSLS)
  i4_2 ~ hnu4_2 * 1
  i5_2 ~ hnu5_2 * 1

  # Residual variances
  i1_2 ~~ htheta1_2 * i1_2
  i2_2 ~~ htheta2_2 * i2_2
  # i3_2 ~~ htheta3_2 * i3_2 (item not in HSLS)
  i4_2 ~~ htheta4_2 * i4_2
  i5_2 ~~ htheta5_2 * i5_2

  # Covariances among items
  i1 ~~ i2
  i1_2 ~~ i2_2
  
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i2 ~~ i4
  i2_2 ~~ i4_2

  i1 ~~ i5
  i1_2 ~~ i5_2

  # Free latent variance and free latent mean
  math_t2 ~~ var_hsls_t2 * math_t2
  math_t2 ~ mean_hsls_t2 * 1

  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  # i3 ~~ i3_2 (item not in HSLS)
  i4 ~~ i4_2
  i5 ~~ i5_2

'

fit_strong_within  <- cfa(strong_within, data = dat, group = "sample", 
                    estimator = "MLR", missing = "FIML", se = "robust.mlr",
                    std.lv = TRUE)
fit_strong_within

head(modindices(fit_strong_within, sort. = TRUE, free.remove = FALSE))

s_strong_within <- summary(fit_strong_within, fit.measures = TRUE, standardized = TRUE)
#s_strong_within
fitMeasures(fit_strong_within, c("rmsea", "chisq.scaled", "cfi", "tli", "df"))

```



# WITHIN+BETWEEN WEAK

```{r}
# Latent variance and mean set to 1 and 0 in ELS time 1, 
# free variance, mean set to 0 everywhere else

both_weak_comb <- '

############################################################################
##                           ELS (Group 1)                                ##
############################################################################
group: ELS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1 * i1 +
             l2 * i2 +
             l3 * i3 +
             l4 * i4 +
             l5 * i5

  # Intercepts
  i1 ~ 0 * 1
  i2 ~ enu2_1 * 1
  i3 ~ enu3_1 * 1
  i4 ~ enu4_1 * 1
  i5 ~ enu5_1 * 1

  # Residual variances
  i1 ~~ etheta1_1 * i1
  i2 ~~ etheta2_1 * i2
  i3 ~~ etheta3_1 * i3
  i4 ~~ etheta4_1 * i4
  i5 ~~ etheta5_1 * i5

  # Free both
  math_t1 ~~ var_els_t1 * math_t1
  math_t1 ~ mean_els_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1 * i1_2 +
             l2 * i2_2 +
             l3 * i3_2 +
             l4 * i4_2 +
             l5 * i5_2

  # Intercepts
  i1_2 ~ 0 * 1
  i2_2 ~ enu2_2 * 1
  i3_2 ~ enu3_2 * 1
  i4_2 ~ enu4_2 * 1
  i5_2 ~ enu5_2 * 1

  # Residual variances
  i1_2 ~~ etheta1_2 * i1_2
  i2_2 ~~ etheta2_2 * i2_2
  i3_2 ~~ etheta3_2 * i3_2
  i4_2 ~~ etheta4_2 * i4_2
  i5_2 ~~ etheta5_2 * i5_2

  # Covariances among items
  
  i1 ~~ i5
  i1_2 ~~ i5_2
  
  i1 ~~ i3
  i1_2 ~~ i3_2
  
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i2 ~~ i3
  i2_2 ~~ i3_2
  
  i4 ~~ i5
  i4_2 ~~ i5_2


  # Free both
  math_t2 ~~ var_els_t2 * math_t2
  math_t2 ~ mean_els_t2 * 1
  
  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2


############################################################################
##                          HSLS (Group 2)                                ##
############################################################################
group: HSLS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1 * i1 +
             l2 * i2 +   # Same label as ELS
             # no i3 in HSLS
             l4 * i4 +   # Same label as ELS
             l5 * i5     # Same label as ELS

  # Intercepts
  i1 ~ 0 * 1
  i2 ~ hnu2_1 * 1
  # i3 ~ hnu3_1 * 1 (item not in HSLS)
  i4 ~ hnu4_1 * 1
  i5 ~ hnu5_1 * 1

  # Residual variances
  i1 ~~ htheta1_1 * i1
  i2 ~~ htheta2_1 * i2
  # i3 ~~ htheta3_1 * i3 (item not in HSLS)
  i4 ~~ htheta4_1 * i4
  i5 ~~ htheta5_1 * i5

  # Free both
  math_t1 ~~ var_hsls_t1 * math_t1
  math_t1 ~ mean_hsls_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1 * i1_2 +
             l2 * i2_2 +   # Same label as ELS
             # no i3_2 in HSLS at Time 2
             l4 * i4_2 +   # Same label as ELS
             l5 * i5_2     # Same label as ELS

  # Intercepts
  i1_2 ~ 0 * 1
  i2_2 ~ hnu2_2 * 1
  # i3_2 ~ hnu3_2 * 1 (item not in HSLS)
  i4_2 ~ hnu4_2 * 1
  i5_2 ~ hnu5_2 * 1

  # Residual variances
  i1_2 ~~ htheta1_2 * i1_2
  i2_2 ~~ htheta2_2 * i2_2
  # i3_2 ~~ htheta3_2 * i3_2 (item not in HSLS)
  i4_2 ~~ htheta4_2 * i4_2
  i5_2 ~~ htheta5_2 * i5_2

  # Covariances among items
  
  
  i1 ~~ i5
  i1_2 ~~ i5_2
  
  # i1 ~~ i3
  # i1_2 ~~ i3_2
    
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i4 ~~ i5
  i4_2 ~~ i5_2

  # Free latent variance and free latent mean
  math_t2 ~~ var_hsls_t2 * math_t2
  math_t2 ~ mean_hsls_t2 * 1

  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  # i3 ~~ i3_2 (item not in HSLS)
  i4 ~~ i4_2
  i5 ~~ i5_2

'

fit_both_weak_comb  <- sem(both_weak_comb, data = dat, group = "sample", 
                    estimator = "MLR", missing = "FIML", se = "robust.mlr")
fit_both_weak_comb

fitMeasures(fit_both_weak_comb, c("rmsea", "chisq.scaled", "cfi", "tli", "df", "aic", "bic"))

head(modindices(fit_both_weak_comb, sort. = TRUE, free.remove = FALSE))

s_both_weak_comb <- summary(fit_both_weak_comb, fit.measures = TRUE, standardized = TRUE)
#s_both_weak_comb
```

# WITHIN+BETWEEN STRONG

```{r}
both_strong_comb <- '

############################################################################
##                           ELS (Group 1)                                ##
############################################################################
group: ELS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1 * i1 +
             l2 * i2 +
             l3 * i3 +
             l4 * i4 +
             l5 * i5

  ###########
  # Equal Intercepts #
  ###########
   i1 ~ 0 * 1
   i2 ~ nu2 * 1
   i3 ~ nu3 * 1
   i4 ~ nu4 * 1
   i5 ~ nu5 * 1
   
  # Residual variances
  i1 ~~ etheta1_1 * i1
  i2 ~~ etheta2_1 * i2
  i3 ~~ etheta3_1 * i3
  i4 ~~ etheta4_1 * i4
  i5 ~~ etheta5_1 * i5

  # Free latent mean and variance
  math_t1 ~~ var_els_t1 * math_t1
  math_t1 ~ mean_els_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1 * i1_2 +
             l2 * i2_2 +
             l3 * i3_2 +
             l4 * i4_2 +
             l5 * i5_2

  ###########
  # Equal Intercepts #
  ###########
  # Intercepts
  i1_2 ~ 0 * 1
  i2_2 ~ nu2 * 1
  i3_2 ~ nu3 * 1
  i4_2 ~ nu4 * 1
  i5_2 ~ nu5 * 1

  # Residual variances
  i1_2 ~~ etheta1_2 * i1_2
  i2_2 ~~ etheta2_2 * i2_2
  i3_2 ~~ etheta3_2 * i3_2
  i4_2 ~~ etheta4_2 * i4_2
  i5_2 ~~ etheta5_2 * i5_2

  # Covariances among items
  
  i1 ~~ i5
  i1_2 ~~ i5_2
  
  i1 ~~ i3
  i1_2 ~~ i3_2
  
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i2 ~~ i3
  i2_2 ~~ i3_2
  
  i4 ~~ i5
  i4_2 ~~ i5_2


  # Free latent variance, free mean
  math_t2 ~~ var_els_t2 * math_t2
  math_t2 ~ mean_els_t2 * 1
  
  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2


############################################################################
##                          HSLS (Group 2)                                ##
############################################################################
group: HSLS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1 * i1 +
             l2 * i2 +   # Same label as ELS
             # no i3 in HSLS
             l4 * i4 +   # Same label as ELS
             l5 * i5     # Same label as ELS

  ###########
  # Equal Intercepts #
  ###########
  
   i1 ~ 0 * 1
   i2 ~ nu2 * 1
  #i3 ~ nu3 * 1 (item not in HSLS)
   i4 ~ nu4 * 1
   i5 ~ nu5 * 1

  # Residual variances
  i1 ~~ htheta1_1 * i1
  i2 ~~ htheta2_1 * i2
  # i3 ~~ htheta3_1 * i3 (item not in HSLS)
  i4 ~~ htheta4_1 * i4
  i5 ~~ htheta5_1 * i5

  # Free latent variance and mean
  math_t1 ~~ var_hsls_t1 * math_t1
  math_t1 ~ mean_hsls_t1 * 1 


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1 * i1_2 +
             l2 * i2_2 +   # Same label as ELS
             # no i3_2 in HSLS at Time 2
             l4 * i4_2 +   # Same label as ELS
             l5 * i5_2     # Same label as ELS

  ###########
  # Equal Intercepts #
  ###########
  
   i1_2 ~ 0 * 1
   i2_2 ~ nu2 * 1
  #i3_2 ~ nu3 * 1 (item not in HSLS)
   i4_2 ~ nu4 * 1
   i5_2 ~ nu5 * 1

  # Residual variances
  i1_2 ~~ htheta1_2 * i1_2
  i2_2 ~~ htheta2_2 * i2_2
  # i3_2 ~~ htheta3_2 * i3_2 (item not in HSLS)
  i4_2 ~~ htheta4_2 * i4_2
  i5_2 ~~ htheta5_2 * i5_2

  # Covariances among items
  
  
  i1 ~~ i5
  i1_2 ~~ i5_2
  
  # i1 ~~ i3
  # i1_2 ~~ i3_2
    
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i4 ~~ i5
  i4_2 ~~ i5_2

  # Free latent variance 
  math_t2 ~~ var_hsls_t2 * math_t2
  math_t2 ~ mean_hsls_t2 * 1 #free mean

  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  # i3 ~~ i3_2 (item not in HSLS)
  i4 ~~ i4_2
  i5 ~~ i5_2

'

fit_both_strong_comb  <- 
  sem(both_strong_comb, data = dat, group = "sample", 
                    estimator = "MLR", missing = "FIML", se = "robust.mlr")

fit_both_strong_comb

fitMeasures(fit_both_strong_comb, c("rmsea", "chisq.scaled", "cfi", "tli", "df", "aic", "bic"))

head(modindices(fit_both_strong_comb, sort. = TRUE, free.remove = FALSE))

s_both_strong_comb <- summary(fit_both_strong_comb, fit.measures = TRUE, standardized = TRUE)
#s_both_strong_comb


```


# W/B Partial Strong 
```{r}
both_strong_partial_ei4 <- '

############################################################################
##                           ELS (Group 1)                                ##
############################################################################
group: ELS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1 * i1 +
             l2 * i2 +
             l3 * i3 +
             l4 * i4 +
             l5 * i5

  ###########
  # Equal Intercepts #
  ###########
   i1 ~ 0 * 1
   i2 ~ nu2 * 1
   i3 ~ nu3 * 1
   
   # Unique i4 intercept
   i4 ~ nu4_1 * 1
   
   i5 ~ nu5 * 1
   
  # Residual variances
  i1 ~~ etheta1_1 * i1
  i2 ~~ etheta2_1 * i2
  i3 ~~ etheta3_1 * i3
  i4 ~~ etheta4_1 * i4
  i5 ~~ etheta5_1 * i5

  # Free latent mean and variance
  math_t1 ~~ var_els_t1 * math_t1
  math_t1 ~ mean_els_t1 * 1


  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1 * i1_2 +
             l2 * i2_2 +
             l3 * i3_2 +
             l4 * i4_2 +
             l5 * i5_2

  ###########
  # Equal Intercepts #
  ###########
  # Intercepts
  i1_2 ~ 0 * 1
  i2_2 ~ nu2 * 1
  i3_2 ~ nu3 * 1
  i4_2 ~ nu4 * 1
  i5_2 ~ nu5 * 1

  # Residual variances
  i1_2 ~~ etheta1_2 * i1_2
  i2_2 ~~ etheta2_2 * i2_2
  i3_2 ~~ etheta3_2 * i3_2
  i4_2 ~~ etheta4_2 * i4_2
  i5_2 ~~ etheta5_2 * i5_2

  # Covariances among items
  
  i1 ~~ i5
  i1_2 ~~ i5_2
  
  i1 ~~ i3
  i1_2 ~~ i3_2
  
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i2 ~~ i3
  i2_2 ~~ i3_2
  
  i4 ~~ i5
  i4_2 ~~ i5_2


  # Free latent variance, free mean
  math_t2 ~~ var_els_t2 * math_t2
  math_t2 ~ mean_els_t2 * 1
  
  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  i3 ~~ i3_2
  i4 ~~ i4_2
  i5 ~~ i5_2


############################################################################
##                          HSLS (Group 2)                                ##
############################################################################
group: HSLS

  #####################
  # Time Point 1
  #####################
  math_t1 =~ l1 * i1 +
             l2 * i2 +   # Same label as ELS
             # no i3 in HSLS
             l4 * i4 +   # Same label as ELS
             l5 * i5     # Same label as ELS

  ###########
  # Equal Intercepts #
  ###########
   i1 ~ 0 * 1
   i2 ~ nu2 * 1
  #i3 ~ nu3 * 1 (item not in HSLS)
   i4 ~ nu4 * 1
   i5 ~ nu5 * 1

  # Residual variances
  i1 ~~ htheta1_1 * i1
  i2 ~~ htheta2_1 * i2
  # i3 ~~ htheta3_1 * i3 (item not in HSLS)
  i4 ~~ htheta4_1 * i4
  i5 ~~ htheta5_1 * i5

  # Free latent variance and mean
  math_t1 ~~ var_hsls_t1 * math_t1
  math_t1 ~ mean_hsls_t1 * 1 

  #####################
  # Time Point 2
  #####################
  math_t2 =~ l1 * i1_2 +
             l2 * i2_2 +   # Same label as ELS
             # no i3_2 in HSLS at Time 2
             l4 * i4_2 +   # Same label as ELS
             l5 * i5_2     # Same label as ELS

  ###########
  # Equal Intercepts #
  ###########
  
   i1_2 ~ 0 * 1
   i2_2 ~ nu2 * 1
  #i3_2 ~ nu3 * 1 (item not in HSLS)
   i4_2 ~ nu4 * 1
   i5_2 ~ nu5 * 1

  # Residual variances
  i1_2 ~~ htheta1_2 * i1_2
  i2_2 ~~ htheta2_2 * i2_2
  # i3_2 ~~ htheta3_2 * i3_2 (item not in HSLS)
  i4_2 ~~ htheta4_2 * i4_2
  i5_2 ~~ htheta5_2 * i5_2

  # Covariances among items
  
  
  i1 ~~ i5
  i1_2 ~~ i5_2
  
  # i1 ~~ i3
  # i1_2 ~~ i3_2
    
  i1 ~~ i4
  i1_2 ~~ i4_2
  
  i4 ~~ i5
  i4_2 ~~ i5_2

  # Free latent variance 
  math_t2 ~~ var_hsls_t2 * math_t2
  math_t2 ~ mean_hsls_t2 * 1 #free mean

  # Correlations across time
  math_t1 ~~ math_t2
  i1 ~~ i1_2
  i2 ~~ i2_2
  # i3 ~~ i3_2 (item not in HSLS)
  i4 ~~ i4_2
  i5 ~~ i5_2

'

fit_both_strong_partial_ei4  <- sem(both_strong_partial_ei4, data = dat, group = "sample", 
                    estimator = "MLR", missing = "FIML", se = "robust.mlr")
fit_both_strong_partial_ei4

fitMeasures(fit_both_strong_partial_ei4, c("rmsea", "chisq.scaled", "cfi", "tli", "df", "aic", "bic"))

head(modindices(fit_both_strong_partial_ei4, sort. = TRUE, free.remove = FALSE))

s_both_strong_comb <- summary(fit_both_strong_partial_ei4, fit.measures = TRUE, standardized = TRUE)



```


# HSLS ONLY

```{r}
# hsls_time <-  '
#   math_T1 =~ NA  * i1 + 
#             l2_1 * i2 + 
#             l4_1 * i4 + 
#             l5_1 * i5
# 
#   
#   # Fixing latent variance to 1, as we freed first factor loading
#   math_T1 ~~ 1 * math_T1
#   
#   # Fixing latent mean to 0 for identification?
#   math_T1 ~ 0 * 1  
#   
#   # Time Point 2
#   math_T2 =~ NA  * i1_2 + 
#             l2_2 * i2_2 + 
#             l4_2 * i4_2 + 
#             l5_2 * i5_2
# 
# 
# 
#   # Adding the covariances
#   i1_2 ~~ i2_2
#   i2_2 ~~ i4_2
#     
#   i1 ~~ i5
#   i1_2 ~~ i5_2
#   
#   # Fixing latent variance to 1, as we freed first factor loading
#   math_T2 ~~ 1 * math_T2
#   
#   # Fixing latent mean to 0 for identification?
#   math_T2 ~ 0 * 1
#   
#   # Correlations across time
#   math_T1 ~~ math_T2
#   i1 ~~ i1_2
#   i2 ~~ i2_2
#   i4 ~~ i4_2
#   i5 ~~ i5_2     
# '
# 
# fit_hsls_time  <- cfa(hsls_time, data = hsls, 
#                      estimator = "MLR", missing = "FIML", se = "robust.mlr")
# fit_hsls_time
# head(modindices(fit_hsls_time, sort. = TRUE, free.remove = FALSE))
# 
# 
# s_hsls_time <- summary(fit_hsls_time, fit.measures = TRUE)
# 
# 

```

# ELS ONLY

```{r}

# els_time <-  '
#   math_T1 =~ l1_1 * NA  * i1 +
#             l2_1 * i2 +
#             l3_1 * i3 +
#             l4_1 * i4 +
#             l5_1 * i5
# 
# 
#   # Fixing latent variance to 1, as we freed first factor loading
#   math_T1 ~~ NA * math_T1
# 
#   # Fixing latent mean to 0 for identification?
#   math_T1 ~ 0 * 1
# 
#   # Time Point 2
#   math_T2 =~ NA  * i1_2 +
#             l2_2 * i2_2 +
#             l3_2 * i3_2 +
#             l4_2 * i4_2 +
#             l5_2 * i5_2
# 
#   # Adding the covariances
#   i1 ~~ i2
#   i1_2 ~~ i2_2
# 
#   i2 ~~ i3
#   i2_2 ~~ i3_2
# 
#   i4 ~~ i5
#   i4_2 ~~ i5_2
# 
# 
# 
# 
#   # Fixing latent variance to 1, as we freed first factor loading
#   math_T2 ~~ NA * math_T2
# 
#   # Fixing latent mean to 0 for identification?
#   math_T2 ~ 0 * 1
# 
#   # Correlations across time
#   math_T1 ~~ math_T2
#   i1 ~~ i1_2
#   i2 ~~ i2_2
#   i3 ~~ i3_2
#   i4 ~~ i4_2
#   i5 ~~ i5_2
# '
# 
# fit_els_time  <- cfa(els_time, data = els,
#                      estimator = "MLR", missing = "FIML", se = "robust.mlr")
# fit_els_time
# head(modindices(fit_els_time, sort. = TRUE, free.remove = FALSE))
# 
# s_els_time <- summary(fit_els_time, fit.measures = TRUE, standardized = TRUE)



```


# K-fold validation
```{r}
library(caret)

k <- 10  # Number of folds
set.seed(42)
folds <- createFolds(dat$sample, k = k, list = TRUE)

cfi_list <- numeric(k)
rmsea_list <- numeric(k)
srmr_list <- numeric(k)
chisq_list <- numeric(k)

for (i in seq_along(folds)) {
  # Split into training and validation
  validation_indices <- folds[[i]]
  train_data <- dat[-validation_indices, ]
  validation_data <- dat[validation_indices, ]
  
  # Fit model on training set
  fit_train <- fit_train <- sem(both_strong_partial_ei4, data = train_data, 
                                group = "sample", 
                                estimator = "MLR", 
                                missing = "FIML", 
                                se = "robust.mlr")
  
  # Fit model on validation set using training constraints
  fit_validation <- fit_validation <- sem(both_strong_partial_ei4, 
                                          data = validation_data, 
                                          group = "sample", 
                                          estimator = "MLR", 
                                          missing = "FIML", se = "robust.mlr")
  
  # Extract fit measures for the validation set
  cfi_list[i] <- fitMeasures(fit_validation, "cfi")
  rmsea_list[i] <- fitMeasures(fit_validation, "rmsea")
  srmr_list[i] <- fitMeasures(fit_validation, "srmr")
  chisq_list[i] <- fitMeasures(fit_validation, "chisq.scaled")
}

fit_measures_summary <- data.frame(
  Fold = seq_len(k),
  CFI = cfi_list,
  RMSEA = rmsea_list,
  SRMR = srmr_list,
  chisquare = chisq_list
)

fit_measures_summary <- rbind(
  fit_measures_summary,
  data.frame(
    Fold = "Mean",
    CFI = mean(cfi_list),
    RMSEA = mean(rmsea_list),
    SRMR = mean(srmr_list),
    chisquare = mean(chisq_list)
  ),
  data.frame(
    Fold = "SD",
    CFI = sd(cfi_list),
    RMSEA = sd(rmsea_list),
    SRMR = sd(srmr_list),
    chisquare = sd(chisq_list)
  )
)

# Display fit measures summary
print(fit_measures_summary)
```

```{r}

k <- 10  # Number of folds
set.seed(42)
folds_2 <- createFolds(dat$sample, k = k, list = TRUE)

cfi_list_2 <- numeric(k)
rmsea_list_2 <- numeric(k)
srmr_list_2 <- numeric(k)
chisq_list_2 <- numeric(k)

for (i in seq_along(folds_2)) {
  # Split into training and validation
  validation_indices_2 <- folds_2[[i]]
  train_data_2 <- dat[-validation_indices_2, ]
  validation_data_2 <- dat[validation_indices_2
                           , ]
  
  # Fit model on training set
  fit_train_2 <- sem(both_strong_comb, data = train_data, 
                                group = "sample", 
                                estimator = "MLR", 
                                missing = "FIML", 
                                se = "robust.mlr")
  
  # Fit model on validation set using training constraints
  fit_validation_2 <- sem(both_strong_comb, 
                                          data = validation_data_2, 
                                          group = "sample", 
                                          estimator = "MLR", 
                                          missing = "FIML", se = "robust.mlr")
  
  # Extract fit measures for the validation set
  cfi_list_2[i] <- fitMeasures(fit_validation_2, "cfi")
  rmsea_list_2[i] <- fitMeasures(fit_validation_2, "rmsea")
  srmr_list_2[i] <- fitMeasures(fit_validation_2, "srmr")
  chisq_list_2[i] <- fitMeasures(fit_validation_2, 'chisq.scaled')
}

fit_measures_summary_2 <- data.frame(
  Fold = seq_len(k),
  CFI = cfi_list_2,
  RMSEA = rmsea_list_2,
  SRMR = srmr_list_2,
  chisquare =  chisq_list_2
)

# Calculate mean and standard deviation of fit measures across folds
fit_measures_summary_2 <- rbind(
  fit_measures_summary_2,
  data.frame(
    Fold = "Mean",
    CFI = mean(cfi_list_2),
    RMSEA = mean(rmsea_list_2),
    SRMR = mean(srmr_list_2),
    chisquare = mean(chisq_list_2)
  ),
  data.frame(
    Fold = "SD",
    CFI = sd(cfi_list_2),
    RMSEA = sd(rmsea_list_2),
    SRMR = sd(srmr_list_2),
    chisquare = sd(chisq_list_2)
  )
)

# Display fit measures summary
print(fit_measures_summary_2)

```
















